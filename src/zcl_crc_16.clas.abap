class ZCL_CRC_16 definition
  public
  final
  create public .

public section.

  class-methods CRC16_MAP .
  class-methods CALC
    importing
      !I_PAYLOAD type STRING
    returning
      value(R_CRC16) type CHAR4 .
protected section.
private section.

  types:
    ty_crcmap TYPE x LENGTH 4 .
  types:
    TT_CRCMAP TYPE TABLE OF ty_crcmap WITH DEFAULT KEY .

  class-data GT_CRC16MAP type TT_CRCMAP .
ENDCLASS.



CLASS ZCL_CRC_16 IMPLEMENTATION.


METHOD calc.

  CONSTANTS: x0000ffff(4) TYPE x VALUE '0000FFFF',
             x00000000(4) TYPE x VALUE '00000000',
             x000000ff(4) TYPE x VALUE '000000FF',
             x000000(3)   TYPE x VALUE '000000'.

  DATA: lv_xstring  TYPE xstring,

        i           TYPE i,
        lv_len      TYPE i,
        j           TYPE p LENGTH 16,

        hex_crc     TYPE x LENGTH 4 VALUE x0000ffff,
        hex_r       TYPE x LENGTH 4,
        hex_l       TYPE x LENGTH 4,
        hex_aux     TYPE x LENGTH 4.

  "To XSTRING
  lv_xstring = cl_bcs_convert=>string_to_xstring( i_payload ).
  lv_len = xstrlen( lv_xstring ).

  IF gt_crc16map IS INITIAL.
    crc16_map( ).
  ENDIF.

  DO lv_len TIMES.

    "Complete Hex of Caracter
    i = sy-index - 1.
    CONCATENATE  x000000 lv_xstring+i(1) INTO  hex_aux  IN BYTE MODE.

    "crc >> 8
    hex_r =  hex_crc.
    SHIFT hex_r BY 1 PLACES RIGHT IN BYTE MODE.

    "crc << 8
    hex_l =  hex_crc.
    SHIFT hex_l BY 1 PLACES LEFT IN BYTE MODE.

    "Get Index
    j = hex_aux = ( hex_aux BIT-XOR hex_r ) BIT-AND x000000ff.

    "Get poly crc (1021)
    ADD 1 TO j.
    READ TABLE gt_crc16map INTO hex_aux INDEX j.

    "Calc Caracter
    j = hex_crc = hex_aux BIT-XOR hex_l.

  ENDDO.

  hex_crc = ( hex_crc BIT-XOR x00000000 ) BIT-AND x0000ffff.

  r_crc16 = hex_crc+2.

ENDMETHOD.


METHOD crc16_map.

  DEFINE add_map.
    append &1 to gt_crc16map.
  END-OF-DEFINITION.


  add_map:
  '00000000', '00001021', '00002042', '00003063', '00004084', '000050A5',
  '000060C6', '000070E7', '00008108', '00009129', '0000A14A', '0000B16B',
  '0000C18C', '0000D1AD', '0000E1CE', '0000F1EF', '00001231', '00000210',
  '00003273', '00002252', '000052B5', '00004294', '000072F7', '000062D6',
  '00009339', '00008318', '0000B37B', '0000A35A', '0000D3BD', '0000C39C',
  '0000F3FF', '0000E3DE', '00002462', '00003443', '00000420', '00001401',
  '000064E6', '000074C7', '000044A4', '00005485', '0000A56A', '0000B54B',
  '00008528', '00009509', '0000E5EE', '0000F5CF', '0000C5AC', '0000D58D',
  '00003653', '00002672', '00001611', '00000630', '000076D7', '000066F6',
  '00005695', '000046B4', '0000B75B', '0000A77A', '00009719', '00008738',
  '0000F7DF', '0000E7FE', '0000D79D', '0000C7BC', '000048C4', '000058E5',
  '00006886', '000078A7', '00000840', '00001861', '00002802', '00003823',
  '0000C9CC', '0000D9ED', '0000E98E', '0000F9AF', '00008948', '00009969',
  '0000A90A', '0000B92B', '00005AF5', '00004AD4', '00007AB7', '00006A96',
  '00001A71', '00000A50', '00003A33', '00002A12', '0000DBFD', '0000CBDC',
  '0000FBBF', '0000EB9E', '00009B79', '00008B58', '0000BB3B', '0000AB1A',
  '00006CA6', '00007C87', '00004CE4', '00005CC5', '00002C22', '00003C03',
  '00000C60', '00001C41', '0000EDAE', '0000FD8F', '0000CDEC', '0000DDCD',
  '0000AD2A', '0000BD0B', '00008D68', '00009D49', '00007E97', '00006EB6',
  '00005ED5', '00004EF4', '00003E13', '00002E32', '00001E51', '00000E70',
  '0000FF9F', '0000EFBE', '0000DFDD', '0000CFFC', '0000BF1B', '0000AF3A',
  '00009F59', '00008F78', '00009188', '000081A9', '0000B1CA', '0000A1EB',
  '0000D10C', '0000C12D', '0000F14E', '0000E16F', '00001080', '000000A1',
  '000030C2', '000020E3', '00005004', '00004025', '00007046', '00006067',
  '000083B9', '00009398', '0000A3FB', '0000B3DA', '0000C33D', '0000D31C',
  '0000E37F', '0000F35E', '000002B1', '00001290', '000022F3', '000032D2',
  '00004235', '00005214', '00006277', '00007256', '0000B5EA', '0000A5CB',
  '000095A8', '00008589', '0000F56E', '0000E54F', '0000D52C', '0000C50D',
  '000034E2', '000024C3', '000014A0', '00000481', '00007466', '00006447',
  '00005424', '00004405', '0000A7DB', '0000B7FA', '00008799', '000097B8',
  '0000E75F', '0000F77E', '0000C71D', '0000D73C', '000026D3', '000036F2',
  '00000691', '000016B0', '00006657', '00007676', '00004615', '00005634',
  '0000D94C', '0000C96D', '0000F90E', '0000E92F', '000099C8', '000089E9',
  '0000B98A', '0000A9AB', '00005844', '00004865', '00007806', '00006827',
  '000018C0', '000008E1', '00003882', '000028A3', '0000CB7D', '0000DB5C',
  '0000EB3F', '0000FB1E', '00008BF9', '00009BD8', '0000ABBB', '0000BB9A',
  '00004A75', '00005A54', '00006A37', '00007A16', '00000AF1', '00001AD0',
  '00002AB3', '00003A92', '0000FD2E', '0000ED0F', '0000DD6C', '0000CD4D',
  '0000BDAA', '0000AD8B', '00009DE8', '00008DC9', '00007C26', '00006C07',
  '00005C64', '00004C45', '00003CA2', '00002C83', '00001CE0', '00000CC1',
  '0000EF1F', '0000FF3E', '0000CF5D', '0000DF7C', '0000AF9B', '0000BFBA',
  '00008FD9', '00009FF8', '00006E17', '00007E36', '00004E55', '00005E74',
  '00002E93', '00003EB2', '00000ED1', '00001EF0'." to GT_CRC16MAP.

ENDMETHOD.
ENDCLASS.
